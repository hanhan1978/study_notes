# WebエンジニアのためのC言語入門ハンズオン #2

注意！本内容は「WebエンジニアのためのC言語入門ハンズオン #1」をやったことを前提にしています。

# 今日習得すること
+ mallocとfree
+ 構造体 
+ データ構造の自作
+ ヘッダーファイル
+ 実習

# 前回のおさらい
## データ型
+ char
+ int
+ float
+ double
+ 上記データ型の配列
※文字列型とかありません。

## 文法
+ `if else`
+ `for while`
+ `switch`
+ `サブルーチン(function)`
+ `break continue`
+ `gotoと名札`

## 仮想アドレス空間
![仮想アドレス空間](https://raw.githubusercontent.com/hanhan1978/study_notes/master/memory.png)

## ポインター
C言語では、全ての引数は値渡しです。

そのため、基本データ型(`char`,`int`,`float`,`double`)以外のデータをやり取りしたい場合は
型を指定したメモリアドレスを使って、関数間のデータの受け渡しを行います。

ポインターで利用する演算子は、主に以下の2つです。
+ 間接演算子 `*`
+ アドレス演算子 `&`

# 1. mallocとfree
## ヒープに領域を確保する
余程の小さいプログラムを除いて、プログラム内の関数間でデータをやり取りするため
C言語のプログラムでは、`malloc`という関数を使ってヒープに領域を確保して、情報を保持させます。

`malloc`は`stdlib.h`という共有ライブラリに含まれます。

memory allocationを略したものです。


`free`は、ヒープに確保した領域を解放します。
ヒープに確保した領域は明示的に解放しなければ、プログラムの実行が終了するまで解放されません。

デーモンプログラムなどでは、メモリの解放忘れは致命的です。
プロセスが長く生存するに従って、解放されないメモリ領域が増えていき、メモリを使い尽くしてしまいます。
これはメモリリークと呼ばれます。

とある現場では、巨大なデーモンプログラムのどこでメモリリークが発生しているのかを特定出来なかったため
３日に１回の頻度で、強制的に再起動することで、メモリの解放を行っていました。
あのプログラムはまだ動いているのだろうか・・・。

## TODO
mallocでの現実的practiceについて データ型 x サイズでのメモリ量計算等
mallocで思いっきり大きいメモリ量をいきなり割り当てるの術。

## 演習問題 1-1
malloc freeを体験するプログラムです。

## 演習問題 1-2
ヒープを使って、関数間をまたいでデータをやり取りします。

## 演習問題 1-3
アンチパターンとして、グローバル変数を使ってデータの受け渡しをするプログラムを書いてみましょう。

## 演習問題 1-4
分かりにくいパターンとして、共有ライブラリでヒープが使われるパターンをやってみましょう。
自分では明示的にmallocしませんが、freeを必要とするパターンです。

### 重要な考え方
+ メモリ空間を意識出来てない、またはヒープやポインターの使い方がよく分からないという理由で、グローバル変数を多用することがあるそうです。
+ グローバル変数は、プログラム全体で利用できるため、どこでどのように利用されるか分かりません。結果として、一度作られたグローバル変数は基本的に生き続けます。
+ 消せないグローバル変数が山盛りになっていくそうです・・・

# 2. 構造体 

構造体は、基本データ型、及び任意のポインタ
の組み合わせで構成されるユーザ定義のデータの集まりです。

C言語では、関数も関数ポインタという形で、ポインタ扱い可能です。

データを定義できて、関数をもつことができる・・・ん？　オブジェクト指向のクラスに近いです。
アクセス修飾子とかはないですが・・・。

構造体でデータ構造を定義出来れば、プログラムをスッキリ書くことが出来ます。
また、多すぎる引数を持つ関数があった場合にも、構造体のポインターだけを渡すことができれば、見通し良くなります。

## 演習問題2-1
とりあえず構造体を作ってみましょう。


## 構造体の操作
アロー演算子を覚えておきましょう。




# 3. データ構造の自作
C言語では、言語自体がサポートするデータ型が少ないので、欲しいデータ構造は自作するのが普通のようです。



リンクドリストを自作してみましょう。


# 4. ヘッダーファイル

共有ライブラリをインクルードするとき、hoge.hという名前を使いますが、hってなんでしょうか？

ｈの拡張子をもつファイルはヘッダーファイルと呼ばれます。
なるほどなるほど、ヘッダーファイルという特殊なファイルなんだな・・・という考えはNGです。

ヘッダーファイルは、単なるCのファイルです。

C言語では、関数は巻き上がりません。そのため、関数は使う場所よりも前で宣言されている必要があります。
そのため、関数を定義する場合、その定義情報をファイルの最初の方で書いておいて、コンパイル時にそんな関数ないっすっていうエラーになるのを防ぎます。

コンパイルのために、関数の実装とは別に関数の定義を最初に書いておくものをプロトタイプ宣言と呼びます。

## 演習問題4-1
プロトタイプ宣言をやってみましょう。

まずは、プロトタイプ宣言無し。

次に、プロトタイプ宣言を追加

警告の内容をちゃんと読んでみて下さい。

## 演習問題4-2

プロトタイプ宣言や、グローバル変数の定義を一つのファイル
にまとめて、拡張子hでファイルを作成します。




実はこれがヘッダーファイルの正体です。


ある程度の規模のCプログラムであれば、必ずヘッダーファイルを作る・・・と思います。
ヘッダーファイルを用意することで、複数のファイルから、関数を呼び出すことが可能となります。



# 5. 実習
